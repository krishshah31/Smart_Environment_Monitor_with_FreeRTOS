/*
 * ssd1306_driver.c
 *
 *  Created on: 14-Nov-2025
 *      Author: Krish
 */

#include "ssd1306_driver.h"
#include "i2c.h"
#include <string.h>

/* ===== USER CONFIG ===== */
#define SSD1306_I2C        hi2c1
#define SSD1306_ADDR_7BIT  0x3C  /* common: 0x3C. If your module is 0x3D, change it */
#define SSD1306_WIDTH      128
#define SSD1306_HEIGHT     64
/* ======================= */

#define SSD1306_ADDR (SSD1306_ADDR_7BIT << 1)

/* Framebuffer: 128 x 64 / 8 = 1024 bytes */
static uint8_t fb[SSD1306_WIDTH * (SSD1306_HEIGHT / 8)];

/* Minimal 6x8 font for ASCII 32..127 (96 chars). Each char is 6 bytes (5 glyph + 1 spacing).
 * To keep your repo lighter, this is a compact font. */
static const uint8_t font6x8[96][6] = {
    /* Space (32) */ {0,0,0,0,0,0},
    /* ! */ {0x00,0x00,0x5F,0x00,0x00,0x00},
    /* " */ {0x00,0x07,0x00,0x07,0x00,0x00},
    /* # */ {0x14,0x7F,0x14,0x7F,0x14,0x00},
    /* $ */ {0x24,0x2A,0x7F,0x2A,0x12,0x00},
    /* % */ {0x23,0x13,0x08,0x64,0x62,0x00},
    /* & */ {0x36,0x49,0x55,0x22,0x50,0x00},
    /* ' */ {0x00,0x05,0x03,0x00,0x00,0x00},
    /* ( */ {0x00,0x1C,0x22,0x41,0x00,0x00},
    /* ) */ {0x00,0x41,0x22,0x1C,0x00,0x00},
    /* * */ {0x14,0x08,0x3E,0x08,0x14,0x00},
    /* + */ {0x08,0x08,0x3E,0x08,0x08,0x00},
    /* , */ {0x00,0x50,0x30,0x00,0x00,0x00},
    /* - */ {0x08,0x08,0x08,0x08,0x08,0x00},
    /* . */ {0x00,0x60,0x60,0x00,0x00,0x00},
    /* / */ {0x20,0x10,0x08,0x04,0x02,0x00},

    /* 0 */ {0x3E,0x51,0x49,0x45,0x3E,0x00},
    /* 1 */ {0x00,0x42,0x7F,0x40,0x00,0x00},
    /* 2 */ {0x42,0x61,0x51,0x49,0x46,0x00},
    /* 3 */ {0x21,0x41,0x45,0x4B,0x31,0x00},
    /* 4 */ {0x18,0x14,0x12,0x7F,0x10,0x00},
    /* 5 */ {0x27,0x45,0x45,0x45,0x39,0x00},
    /* 6 */ {0x3C,0x4A,0x49,0x49,0x30,0x00},
    /* 7 */ {0x01,0x71,0x09,0x05,0x03,0x00},
    /* 8 */ {0x36,0x49,0x49,0x49,0x36,0x00},
    /* 9 */ {0x06,0x49,0x49,0x29,0x1E,0x00},
    /* : */ {0x00,0x36,0x36,0x00,0x00,0x00},
    /* ; */ {0x00,0x56,0x36,0x00,0x00,0x00},
    /* < */ {0x08,0x14,0x22,0x41,0x00,0x00},
    /* = */ {0x14,0x14,0x14,0x14,0x14,0x00},
    /* > */ {0x00,0x41,0x22,0x14,0x08,0x00},
    /* ? */ {0x02,0x01,0x51,0x09,0x06,0x00},

    /* @ */ {0x32,0x49,0x79,0x41,0x3E,0x00},
    /* A */ {0x7E,0x11,0x11,0x11,0x7E,0x00},
    /* B */ {0x7F,0x49,0x49,0x49,0x36,0x00},
    /* C */ {0x3E,0x41,0x41,0x41,0x22,0x00},
    /* D */ {0x7F,0x41,0x41,0x22,0x1C,0x00},
    /* E */ {0x7F,0x49,0x49,0x49,0x41,0x00},
    /* F */ {0x7F,0x09,0x09,0x09,0x01,0x00},
    /* G */ {0x3E,0x41,0x49,0x49,0x7A,0x00},
    /* H */ {0x7F,0x08,0x08,0x08,0x7F,0x00},
    /* I */ {0x00,0x41,0x7F,0x41,0x00,0x00},
    /* J */ {0x20,0x40,0x41,0x3F,0x01,0x00},
    /* K */ {0x7F,0x08,0x14,0x22,0x41,0x00},
    /* L */ {0x7F,0x40,0x40,0x40,0x40,0x00},
    /* M */ {0x7F,0x02,0x0C,0x02,0x7F,0x00},
    /* N */ {0x7F,0x04,0x08,0x10,0x7F,0x00},
    /* O */ {0x3E,0x41,0x41,0x41,0x3E,0x00},
    /* P */ {0x7F,0x09,0x09,0x09,0x06,0x00},
    /* Q */ {0x3E,0x41,0x51,0x21,0x5E,0x00},
    /* R */ {0x7F,0x09,0x19,0x29,0x46,0x00},
    /* S */ {0x46,0x49,0x49,0x49,0x31,0x00},
    /* T */ {0x01,0x01,0x7F,0x01,0x01,0x00},
    /* U */ {0x3F,0x40,0x40,0x40,0x3F,0x00},
    /* V */ {0x1F,0x20,0x40,0x20,0x1F,0x00},
    /* W */ {0x3F,0x40,0x38,0x40,0x3F,0x00},
    /* X */ {0x63,0x14,0x08,0x14,0x63,0x00},
    /* Y */ {0x07,0x08,0x70,0x08,0x07,0x00},
    /* Z */ {0x61,0x51,0x49,0x45,0x43,0x00},

    /* [ */ {0x00,0x7F,0x41,0x41,0x00,0x00},
    /* \ */ {0x02,0x04,0x08,0x10,0x20,0x00},
    /* ] */ {0x00,0x41,0x41,0x7F,0x00,0x00},
    /* ^ */ {0x04,0x02,0x01,0x02,0x04,0x00},
    /* _ */ {0x40,0x40,0x40,0x40,0x40,0x00},
    /* ` */ {0x00,0x01,0x02,0x04,0x00,0x00},

    /* a */ {0x20,0x54,0x54,0x54,0x78,0x00},
    /* b */ {0x7F,0x48,0x44,0x44,0x38,0x00},
    /* c */ {0x38,0x44,0x44,0x44,0x20,0x00},
    /* d */ {0x38,0x44,0x44,0x48,0x7F,0x00},
    /* e */ {0x38,0x54,0x54,0x54,0x18,0x00},
    /* f */ {0x08,0x7E,0x09,0x01,0x02,0x00},
    /* g */ {0x0C,0x52,0x52,0x52,0x3E,0x00},
    /* h */ {0x7F,0x08,0x04,0x04,0x78,0x00},
    /* i */ {0x00,0x44,0x7D,0x40,0x00,0x00},
    /* j */ {0x20,0x40,0x44,0x3D,0x00,0x00},
    /* k */ {0x7F,0x10,0x28,0x44,0x00,0x00},
    /* l */ {0x00,0x41,0x7F,0x40,0x00,0x00},
    /* m */ {0x7C,0x04,0x18,0x04,0x78,0x00},
    /* n */ {0x7C,0x08,0x04,0x04,0x78,0x00},
    /* o */ {0x38,0x44,0x44,0x44,0x38,0x00},
    /* p */ {0x7C,0x14,0x14,0x14,0x08,0x00},
    /* q */ {0x08,0x14,0x14,0x18,0x7C,0x00},
    /* r */ {0x7C,0x08,0x04,0x04,0x08,0x00},
    /* s */ {0x48,0x54,0x54,0x54,0x20,0x00},
    /* t */ {0x04,0x3F,0x44,0x40,0x20,0x00},
    /* u */ {0x3C,0x40,0x40,0x20,0x7C,0x00},
    /* v */ {0x1C,0x20,0x40,0x20,0x1C,0x00},
    /* w */ {0x3C,0x40,0x30,0x40,0x3C,0x00},
    /* x */ {0x44,0x28,0x10,0x28,0x44,0x00},
    /* y */ {0x0C,0x50,0x50,0x50,0x3C,0x00},
    /* z */ {0x44,0x64,0x54,0x4C,0x44,0x00},

    /* { */ {0x00,0x08,0x36,0x41,0x00,0x00},
    /* | */ {0x00,0x00,0x7F,0x00,0x00,0x00},
    /* } */ {0x00,0x41,0x36,0x08,0x00,0x00},
    /* ~ */ {0x08,0x04,0x08,0x10,0x08,0x00},
    /* DEL */ {0,0,0,0,0,0}
};

static void ssd1306_cmd(uint8_t cmd)
{
    uint8_t data[2] = {0x00, cmd}; /* control byte 0x00 = command */
    (void)HAL_I2C_Master_Transmit(&SSD1306_I2C, SSD1306_ADDR, data, 2, 100);
}

static void ssd1306_data(const uint8_t *data, uint16_t len)
{
    /* control byte 0x40 = data */
    uint8_t tmp[17];
    tmp[0] = 0x40;

    while (len)
    {
        uint16_t chunk = (len > 16) ? 16 : len;
        memcpy(&tmp[1], data, chunk);
        (void)HAL_I2C_Master_Transmit(&SSD1306_I2C, SSD1306_ADDR, tmp, chunk + 1, 100);
        data += chunk;
        len -= chunk;
    }
}

void OLED_Init(void)
{
    /* Init sequence for SSD1306 128x64 */
    ssd1306_cmd(0xAE); // display off
    ssd1306_cmd(0xD5); ssd1306_cmd(0x80); // clock divide
    ssd1306_cmd(0xA8); ssd1306_cmd(0x3F); // multiplex 1/64
    ssd1306_cmd(0xD3); ssd1306_cmd(0x00); // display offset
    ssd1306_cmd(0x40); // start line
    ssd1306_cmd(0x8D); ssd1306_cmd(0x14); // charge pump
    ssd1306_cmd(0x20); ssd1306_cmd(0x00); // horizontal addressing
    ssd1306_cmd(0xA1); // segment remap
    ssd1306_cmd(0xC8); // COM scan dec
    ssd1306_cmd(0xDA); ssd1306_cmd(0x12); // COM pins
    ssd1306_cmd(0x81); ssd1306_cmd(0xCF); // contrast
    ssd1306_cmd(0xD9); ssd1306_cmd(0xF1); // precharge
    ssd1306_cmd(0xDB); ssd1306_cmd(0x40); // vcom detect
    ssd1306_cmd(0xA4); // resume RAM content
    ssd1306_cmd(0xA6); // normal display
    ssd1306_cmd(0xAF); // display on

    OLED_Clear();
    OLED_Update();
}

void OLED_Clear(void)
{
    memset(fb, 0x00, sizeof(fb));
}

static void draw_char(uint8_t x, uint8_t page, char c)
{
    if (c < 32 || c > 127) c = '?';
    const uint8_t *glyph = font6x8[(uint8_t)c - 32];

    /* Each page is 8 pixels tall */
    uint16_t idx = (uint16_t)page * SSD1306_WIDTH + x;
    if (idx + 6 > sizeof(fb)) return;

    for (uint8_t i = 0; i < 6; i++)
        fb[idx + i] = glyph[i];
}

void OLED_PrintLine(uint8_t line, const char *text)
{
    /* line 0..7 for 64px height (8 pages) */
    if (line >= (SSD1306_HEIGHT / 8)) return;

    /* Clear this line first */
    memset(&fb[line * SSD1306_WIDTH], 0x00, SSD1306_WIDTH);

    uint8_t x = 0;
    while (*text && (x + 6) <= SSD1306_WIDTH)
    {
        draw_char(x, line, *text++);
        x += 6;
    }
}

void OLED_Update(void)
{
    ssd1306_cmd(0x21); ssd1306_cmd(0x00); ssd1306_cmd(SSD1306_WIDTH - 1); // column addr
    ssd1306_cmd(0x22); ssd1306_cmd(0x00); ssd1306_cmd((SSD1306_HEIGHT/8) - 1); // page addr

    ssd1306_data(fb, sizeof(fb));
}

